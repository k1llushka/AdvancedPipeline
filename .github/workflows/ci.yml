name: Advanced CI Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/AdvancedCalculator'
  TEST_PATH: 'tests/AdvancedCalculator.Tests'

jobs:
  # –î–∂–æ–±–∞ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ –ª–∏–Ω—Ç–∏–Ω–≥
  code-quality:
    name: üîç –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üßπ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞
      run: |
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        echo "üîß –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        dotnet format ${{ env.PROJECT_PATH }} --verbosity normal || echo "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ" && true

        # –î–ª—è —Ç–µ—Å—Ç–æ–≤ —Ç–æ–∂–µ
        if [ -d "${{ env.TEST_PATH }}" ]; then
          dotnet format ${{ env.TEST_PATH }} --verbosity normal || echo "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ" && true
        fi

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–µ –ø–∞–¥–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
        echo "üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        dotnet format ${{ env.PROJECT_PATH }} --verify-no-changes --verbosity minimal && echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ" || echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º" && true

    - name: üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å..."
        dotnet build --nologo --verbosity minimal || echo "‚ùå –û—à–∏–±–∫–∏ –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–µ"

  # –î–∂–æ–±–∞ 2: –°–±–æ—Ä–∫–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –û–° (–º–∞—Ç—Ä–∏—Ü–∞)
  build:
    name: üî® –°–±–æ—Ä–∫–∞ - ${{ matrix.os }}
    needs: code-quality
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    defaults:
      run:
        shell: bash  # –ò—Å–ø–æ–ª—å–∑—É–µ–º bash –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
      run: |
        echo "üìÅ –°–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        # –î–ª—è Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º PowerShell, –¥–ª—è –¥—Ä—É–≥–∏—Ö - bash
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          # PowerShell –∫–æ–º–∞–Ω–¥—ã –¥–ª—è Windows
          pwsh -Command "
            if (Test-Path '${{ env.PROJECT_PATH }}/bin/Release/net8.0/') {
              Get-ChildItem '${{ env.PROJECT_PATH }}/bin/Release/net8.0/' | Format-Table
            } else {
              Write-Host '‚ö†Ô∏è –ü–∞–ø–∫–∞ —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
            }
          "
        else
          # Bash –∫–æ–º–∞–Ω–¥—ã –¥–ª—è Linux/Mac
          if [ -d "${{ env.PROJECT_PATH }}/bin/Release/net8.0/" ]; then
            ls -la "${{ env.PROJECT_PATH }}/bin/Release/net8.0/"
          else
            echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
          fi
        fi

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–±–æ—Ä–∫–∏
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: ${{ env.PROJECT_PATH }}/bin/Release/
        retention-days: 7

  # –î–∂–æ–±–∞ 3: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
  test:
    name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    needs: code-quality
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore ${{ env.TEST_PATH }}

    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..."
        dotnet test ${{ env.TEST_PATH }} \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --verbosity normal \
          --no-restore

    - name: üìä –ü—É–±–ª–∏–∫—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults/
        retention-days: 30

    - name: üìà –ü—É–±–ª–∏–∫—É–µ–º –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ${{ env.TEST_PATH }}/**/coverage.cobertura.xml
        retention-days: 30

  # –î–∂–æ–±–∞ 4: –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
  package:
    name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    needs: [build, test]
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: üì¶ –°–æ–∑–¥–∞–µ–º NuGet –ø–∞–∫–µ—Ç
      run: |
        mkdir -p packages
        dotnet pack ${{ env.PROJECT_PATH }} --configuration Release --output ./packages --no-restore

    - name: üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
      run: |
        echo "üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:"
        ls -la ./packages/*.nupkg 2>/dev/null || echo "‚ö†Ô∏è –ü–∞–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞–∫–µ—Ç—ã
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./packages/*.nupkg
        retention-days: 30

  # –î–∂–æ–±–∞ 5: –û—Ç—á–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  report:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    needs: [code-quality, build, test, package]
    runs-on: ubuntu-latest

    steps:
    - name: üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
      run: |
        echo "========================================"
        echo "üéâ ADVANCED CI PIPELINE –ó–ê–í–ï–†–®–ï–ù"
        echo "========================================"
        echo ""
        echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
        echo "  üîç –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: ${{ needs.code-quality.result }}"
        echo "  üî® –°–±–æ—Ä–∫–∞:"
        echo "    - Ubuntu: ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }}"
        echo "    - Windows: ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }}"
        echo "    - macOS: ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }}"
        echo "  üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${{ needs.test.result }}"
        echo "  üì¶ –ü–∞–∫–µ—Ç: ${{ needs.package.result }}"
        echo ""
        echo "  üìÖ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
        echo "========================================"

    - name: üîç –°—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–Ω–∞
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ –í—Å–µ –¥–∂–æ–±—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∂–æ–±—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"
          # –ù–µ –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π, –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º
          echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –¥–∂–æ–±"
        fi