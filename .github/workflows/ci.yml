name: Advanced CI Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '8.x'
  PROJECT_PATH: 'src/AdvancedCalculator'
  TEST_PATH: 'tests/AdvancedCalculator.Tests'

jobs:
  # –î–∂–æ–±–∞ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ –ª–∏–Ω—Ç–∏–Ω–≥
  code-quality:
    name: üîç –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üßπ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞
      run: |
        dotnet format ${{ env.PROJECT_PATH }} --verify-no-changes --verbosity detailed
        dotnet format ${{ env.TEST_PATH }} --verify-no-changes --verbosity detailed

    - name: üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
      run: dotnet build --nologo --verbosity quiet

  # –î–∂–æ–±–∞ 2: –°–±–æ—Ä–∫–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –û–° (–º–∞—Ç—Ä–∏—Ü–∞)
  build:
    name: üî® –°–±–æ—Ä–∫–∞ - ${{ matrix.os }}
    needs: code-quality
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: |
        dotnet restore ${{ env.PROJECT_PATH }}
        dotnet build ${{ env.PROJECT_PATH }} --configuration Release

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å–±–æ—Ä–∫–∏
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: ${{ env.PROJECT_PATH }}/bin/Release/
        retention-days: 7

  # –î–∂–æ–±–∞ 3: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
  test:
    name: üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    needs: code-quality
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
      run: |
        dotnet restore ${{ env.TEST_PATH }}
        dotnet test ${{ env.TEST_PATH }} \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --verbosity normal

    - name: üìä –ü—É–±–ª–∏–∫—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults/
        retention-days: 30

    - name: üìà –ü—É–±–ª–∏–∫—É–µ–º –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ${{ env.TEST_PATH }}/**/coverage.cobertura.xml
        retention-days: 30

  # –î–∂–æ–±–∞ 4: –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
  package:
    name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    needs: [build, test]
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –°–æ–∑–¥–∞–µ–º NuGet –ø–∞–∫–µ—Ç
      run: |
        dotnet restore ${{ env.PROJECT_PATH }}
        dotnet pack ${{ env.PROJECT_PATH }} --configuration Release --output ./packages

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞–∫–µ—Ç—ã
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./packages/*.nupkg
        retention-days: 30

  # –î–∂–æ–±–∞ 5: –û—Ç—á–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  report:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    needs: [code-quality, build, test, package]
    runs-on: ubuntu-latest

    steps:
    - name: üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
      run: |
        echo "üéâ CI Pipeline –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
        echo "---"
        echo "‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞: –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ"
        echo "‚úÖ –°–±–æ—Ä–∫–∞: –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ 3 –û–°"
        echo "‚úÖ –¢–µ—Å—Ç—ã: –ó–∞–ø—É—â–µ–Ω—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º"
        echo "‚úÖ –ü–∞–∫–µ—Ç: –°–æ–∑–¥–∞–Ω"
        echo ""
        echo "–í—Ä–µ–º—è: $(date)"

    - name: üîç –°—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–Ω–∞
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ –í—Å–µ –¥–∂–æ–±—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        else
          echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∂–æ–±—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π"
          exit 1
        fi